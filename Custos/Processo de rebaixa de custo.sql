/*------------ENCONTRANDO OS CODPROD DOS PRODUTOS----------------*/
SELECT CODFAB,
       CODPROD,
       DESCRICAO,
       IMPORTADO
  FROM PCPRODUT
 WHERE CODFAB IN (
    '1001001500005', '1001104000011', '3005101300024', '1201602900164', '1201609200049', '1201609200053', '1001602300035', '1001603100116'
    , '1001602300037', '1001603100121', '1001603100123', '1001603100118', '1201602900150', '1001603100128', '1001609900068', '1001609900067'
    , '1001603100122', '1001603100120', '1201602900155', '1001603100114'
);
/

/*----------------------------ESTOQUE E CUSTO NAS FILIAL----------------*/
SELECT *
  FROM (
    SELECT T.CODFILIAL,
           T.CODPROD,
           NVL (T.QTESTGER, 0) AS QTESTGER,
           NVL (T.VALORULTENT, 0) AS VALORULTENT,
           NVL (T.CUSTOFIN, 0) AS CUSTOFIN
      FROM PCEST T
     WHERE T.CODPROD IN (
        811421, 808792, 811631, 810379, 806631, 809256, 811190, 811194, 811193, 811387, 811406, 811399, 809143, 811401, 811402, 811195
        , 811424, 811403, 809964, 810626
    )
) PIVOT (
    SUM (QTESTGER)
QTESTGER, SUM (VALORULTENT) VALORULTENT, SUM (CUSTOFIN) CUSTOFIN
    FOR CODFILIAL
    IN (1, 2, 3, 4, 7, 8)
)
 ORDER BY CODPROD;
/


/*----------------------------ESTOQUE TOTAL----------------*/
SELECT CODPROD,
       SUM (QTEST) AS QTTOTAL
  FROM PCEST E
 WHERE E.CODPROD IN (
    811421, 808792, 811631, 810379, 806631, 809256, 811190, 811194, 811193, 811387, 811406, 811399, 809143, 811401, 811402, 811195
    , 811424, 811403, 809964, 810626
)
 GROUP BY CODPROD;
/

/*---------------------VALOR DA ULTIMA ENTRADA DE COMPRA----------------*/
WITH ULTIMAENTRADA_ESTRELA AS (
    SELECT MAX (M.DTMOV) AS MAX_DTMOV,
           M.CODPROD,
           M.PUNIT
      FROM PCMOV M
     INNER JOIN PCNFENT E ON M.NUMTRANSENT = E.NUMTRANSENT
     WHERE M.CODFILIAL = 2
       AND E.CODFORNEC = 9720
       AND M.CODPROD IN (
        811421, 808792, 811631, 810379, 806631, 809256, 811190, 811194, 811193, 811387, 811406, 811399, 809143, 811401, 811402, 811195
        , 811424, 811403, 809964, 810626
    )
     GROUP BY M.CODPROD,
              M.PUNIT
)
SELECT DISTINCT M.DTMOV,
                M.CODFILIAL,
                M.CODPROD,
                P.DESCRICAO,
                M.NUMNOTA,
                M.PUNIT
  FROM PCMOV M
  LEFT JOIN PCPRODUT P ON M.CODPROD = P.CODPROD
 INNER JOIN PCNFENT E ON M.NUMTRANSENT = E.NUMTRANSENT
 INNER JOIN ULTIMAENTRADA_ESTRELA U ON M.CODPROD = U.CODPROD
   AND M.DTMOV = U.MAX_DTMOV
 WHERE M.CODFILIAL = 2
   AND E.CODFORNEC = 9720
 ORDER BY M.CODPROD,
          M.DTMOV
/

/*-----------------------------------ANÁLISE DE PEÇAS VENDIDAS POR REDE DE CLIENTES OU CLIENTES----------------------------------*/
SELECT *
  FROM (
    SELECT M.CODPROD,
     /*C.CODREDE, */
           S.CODCLI,
           QT
      FROM PCMOV M,
           PCNFSAID S,
           PCCLIENT C
     WHERE M.NUMTRANSVENDA = S.NUMTRANSVENDA
       AND C.CODCLI = S.CODCLI
       AND S.CONDVENDA = 1
       AND S.DTSAIDA > TO_DATE ('01/01/2019', 'DD/MM/YYYY')
       AND M.CODPROD IN (
        803135, 803134, 803133, 803132, 802852, 804032, 806620
    )
) PIVOT (
    SUM (QT)
        /* FOR CODREDE IN (272, 254, 459, 285, 248, 384, 457, 455, 249, 300, 474, 599, 445, 583, 314, 584, 250, 588, 554, 429, 471, 415)*/
    FOR CODCLI
    IN (7354, 410, 386, 388, 4358, 7644, 8645, 7831)
)
 ORDER BY CODPROD;
/