WITH VENDEDORES AS
 (SELECT U.CODUSUR, U.USURDIRFV AS VENDEDOR, V.CODGERENTE
    FROM PCUSUARI U
    LEFT JOIN PCSUPERV V ON V.CODSUPERVISOR = U.CODSUPERVISOR
    LEFT JOIN PCGERENTE G ON V.CODGERENTE = G.CODGERENTE),
CLIENTES AS
 (SELECT C.CODCLI,
         (CASE
           WHEN R.DESCRICAO IS NULL THEN
            ('C' || C.CODCLI)
           ELSE
            ('R' || C.CODREDE)
         END) AS CODCLIREDE,
         (CASE
           WHEN R.DESCRICAO IS NULL THEN
            ('C' || C.CODCLI || ' - ' || C.CLIENTE)
           ELSE
            ('R' || C.CODREDE || ' - ' || UPPER(R.DESCRICAO))
         END) AS CLIENTE_REDE,
         (C.CODCLI || ' - ' || C.CLIENTE) CLIENTE,
         C.BLOQUEIODEFINITIVO AS BLOQ_DEFINITIVO,
         C.CODUSUR1 CODUSUR,
         V.VENDEDOR
    FROM PCCLIENT C
    LEFT JOIN PCREDECLIENTE R ON C.CODREDE = R.CODREDE
   INNER JOIN VENDEDORES V ON C.CODUSUR1 = V.CODUSUR
   WHERE V.CODGERENTE IN (1, 8, 9, 10)),
TITULOS AS
 (SELECT C.CODCLIREDE,
         T.DTPAG,
         T.DTVENC,
         T.VALOR,
         T.NUMTRANSVENDA,
         T.PREST,
         T.CODCOB
    FROM PCPREST T
   INNER JOIN CLIENTES C ON T.CODCLI = C.CODCLI
   WHERE T.CODFILIAL = 2),
TITULOS_ABERTO AS
 (SELECT T.CODCLIREDE, SUM(T.VALOR) VL_A_VENCER
    FROM TITULOS T
   WHERE T.DTPAG IS NULL
     AND T.DTVENC >= TRUNC(SYSDATE)
   GROUP BY T.CODCLIREDE),
TITULOS_VENCIDOS AS
 (SELECT T.CODCLIREDE, SUM(T.VALOR) VLVENC_TOTAL
    FROM TITULOS T
   WHERE T.DTPAG IS NULL
     AND T.DTVENC < TRUNC(SYSDATE)
   GROUP BY T.CODCLIREDE),
MAIOR_OCORRENCIA AS
 (SELECT T.NUMTRANSVENDA, T.PREST, MAX(L.DATA) DATA_MAIOR
    FROM TITULOS T
   INNER JOIN PCLOGCOBMAG L ON T.NUMTRANSVENDA = L.NUMTRANSVENDA
                           AND T.PREST = L.PREST
   INNER JOIN PCOCORBC B ON L.CODOCORRENCIA = B.CODOCORRENCIA
                        AND L.CODBANCO = B.NUMBANCO
   GROUP BY T.NUMTRANSVENDA, T.PREST),
OCORRENCIAS AS
 (SELECT M.NUMTRANSVENDA, M.PREST, L.CODOCORRENCIA, B.OCORRENCIA
    FROM MAIOR_OCORRENCIA M
   INNER JOIN PCLOGCOBMAG L ON M.NUMTRANSVENDA = L.NUMTRANSVENDA
                           AND M.PREST = L.PREST
                           AND M.DATA_MAIOR = L.DATA
   INNER JOIN PCOCORBC B ON L.CODOCORRENCIA = B.CODOCORRENCIA
                        AND L.CODBANCO = B.NUMBANCO),
COBRANCA_MAIS_RECENTE AS
 (SELECT MAX(B.NUMREGCOB) NUMREGCOB_MAX, I.NUMTRANSVENDA, I.PREST
    FROM PCHISTCOB B
   INNER JOIN PCHISTCOBI I ON B.NUMREGCOB = I.NUMREGCOB
   GROUP BY I.NUMTRANSVENDA, I.PREST),
COBRANCAS AS
 (SELECT B.DATA DATAHORA,
         (CASE
           WHEN B.TIPOCONTATO = 'T' THEN
            'TELEFONE'
           WHEN B.TIPOCONTATO = 'C' THEN
            'CARTA'
           WHEN B.TIPOCONTATO = 'E' THEN
            'EMAIL'
           WHEN B.TIPOCONTATO = 'P' THEN
            'PESSOALMENTE'
           WHEN B.TIPOCONTATO = 'F' THEN
            'FAX'
           WHEN B.TIPOCONTATO = 'R' THEN
            'COBRANÇA TERCEIRA'
           WHEN B.TIPOCONTATO = 'J' THEN
            'COBRANÇA JUDICIAL'
         END) TIPOCONTATO,
         I.NUMTRANSVENDA,
         I.PREST,
         I.ATRASO,
         COALESCE(B.OBS3, B.OBS2, B.OBS1) OBSERVACAO
    FROM PCHISTCOB B
   INNER JOIN COBRANCA_MAIS_RECENTE M ON B.NUMREGCOB = M.NUMREGCOB_MAX
   INNER JOIN PCHISTCOBI I ON B.NUMREGCOB = I.NUMREGCOB
                          AND I.NUMTRANSVENDA = M.NUMTRANSVENDA)
SELECT *
  FROM (SELECT C.CLIENTE_REDE,
               C.CLIENTE,
               DECODE(C.BLOQ_DEFINITIVO, 'S', 'SIM', 'NÃO') BLOQ_DEFINITIVO,
               C.CODUSUR,
               C.VENDEDOR,
               (P.DUPLIC || '-' || P.PREST) DUPLICATA,
               P.DTEMISSAO,
               P.DTVENC,
               P.CODCOB,
               (NVL(P.VALOR, 0) - NVL(P.VALORDESC, 0)) AS VALOR,
               (TRUNC(SYSDATE) - P.DTVENC) DIAS_VENCIDO,
               (CASE
                 WHEN (TRUNC(SYSDATE) - P.DTVENC) > 200 AND P.CODCOB = 'JUR' THEN
                  '09-BAIXAR DO JUROS PENDENTE E BLOQUEAR DEFINITIVO CLIENTE'
                WHEN (TRUNC(SYSDATE) - P.DTVENC) > 200 THEN
                  '08-VERIFICAR BAIXA COMO PERDA'
                 WHEN (TRUNC(SYSDATE) - P.DTVENC) > 75 THEN
                  '07-VERIFICAR ENVIO ÁREA JURIDICA'
                 WHEN (TRUNC(SYSDATE) - P.DTVENC) > 45 THEN
                  '06-ENVIAR PARA COBRANÇA EXTERNA'
                  WHEN O.CODOCORRENCIA = '32' THEN
                  '05-NEGOCIAR COM CLIENTE APÓS PROTESTO'                
                   WHEN NVL(P.PROTESTO, 'N') = 'S' AND O.CODOCORRENCIA != '32' THEN
                  '04-TITULO PROTESTADO'              
                   WHEN NVL(P.CARTORIO, 'N') = 'S' AND O.CODOCORRENCIA != '32' THEN
                  '03-TITULO EM CARTÓRIO'  
                 WHEN (TRUNC(SYSDATE) - P.DTVENC) > 5 AND P.CODCOB = 'BK' THEN
                  '02-PRESTES A ENTRAR EM CARTORIO'
                 WHEN (TRUNC(SYSDATE) - P.DTVENC) > 0 THEN
                  '01-TITULO VENCIDO RECENTE'
                 ELSE
                  '10-ERRO'
               END) STATUS,
               DECODE(NVL(P.CARTORIO, 'N'), 'N', 'NÃO', 'SIM') CARTORIO,
               DECODE(NVL(P.PROTESTO, 'N'), 'N', 'NAO', 'SIM') PROTESTO,
               B.DATAHORA,
               B.OBSERVACAO,
               B.ATRASO,
               B.TIPOCONTATO,
               O.CODOCORRENCIA,
               O.OCORRENCIA,
               V.VLVENC_TOTAL,
               NVL(A.VL_A_VENCER, 0) VL_A_VENCER
          FROM PCPREST P
         INNER JOIN CLIENTES C ON P.CODCLI = C.CODCLI
         INNER JOIN TITULOS_VENCIDOS V ON C.CODCLIREDE = V.CODCLIREDE
          LEFT JOIN TITULOS_ABERTO A ON A.CODCLIREDE = V.CODCLIREDE
          LEFT JOIN OCORRENCIAS O ON P.NUMTRANSVENDA = O.NUMTRANSVENDA
                                 AND P.PREST = O.PREST
          LEFT JOIN COBRANCAS B ON P.NUMTRANSVENDA = B.NUMTRANSVENDA
                               AND P.PREST = B.PREST
         WHERE P.DTPAG IS NULL
           AND P.DTVENC < TRUNC(SYSDATE)
           AND (TRUNC(SYSDATE) - P.DTVENC) > 1
         ORDER BY C.CLIENTE_REDE, P.DTVENC)
 ORDER BY STATUS;
