--DUPLICATAS ANALÍTICO
SELECT P.ROWID,
       NUMCHEQUE,
       P.CODBANCO,
       C.CLIENTE,
       P.VALORESTORNO,
       P.PRESTTEF,
       P.NUMTRANSVENDA,
       P.NUMTRANS,
       P.OBSTITULO,
       P.DTPAG,
       P.NSUHOST, 
       P.NSUTEF,
       P.DTTRANSACAOCC,
       P.NUMRESUMO,
       P.PDV,
       P.CODBAIXACARTAOREDE,
       P.DTFECHA,
       P.*
  FROM PCPREST P
  LEFT JOIN PCCLIENT C ON P.CODCLI = C.CODCLI --08/05/2023 - FALTA DEVOLUÇÃO - FAVOR VERIFICAR -- 10/02/2023 - CHAMADO NA R3 | 10/05/2023 - R3 IRÁ REEMBOLSAR - AGUARDANDO A DATA
 WHERE P.NUMTRANSVENDA IN (11652118)
 ORDER BY DUPLIC, TO_NUMBER(PREST);

--CREDITOS_ABERTOS
WITH TRANSACAO_VENDA_DEVOLVIDA AS
 (SELECT NUMTRANSENT, MAX(M.NUMTRANSDEV) AS NUMTRANSVENDA
    FROM PCMOV M
   WHERE NVL(NUMTRANSDEV, 0) <> 0
     AND NVL(NUMTRANSDEV, 0) <> 0
   GROUP BY NUMTRANSENT)
SELECT (C.CODCLI || '-' || T.CLIENTE) CLIENTE,
       C.VALOR AS VALOR_CREDITO,
       C.DTLANC DTLANC_CRED,
       D.NUMTRANSVENDA
  FROM PCCRECLI C
  JOIN PCCLIENT T ON C.CODCLI = T.CODCLI
  JOIN TRANSACAO_VENDA_DEVOLVIDA D ON C.NUMTRANSENTDEVCLI = D.NUMTRANSENT
 WHERE T.CODCLI = 475448;

--CORREÇÃO CLIENTES
SELECT C.ROWID, C.* FROM PCCLIENT C WHERE C.CLIENTE LIKE 'PAYMEE%';

--OBSERVAÇÃO TITULOS
SELECT P.ROWID, P.NUMTRANSVENDA,C.CLIENTE, P.OBSTITULO, P.*
  FROM PCPREST P JOIN PCNFSAID C ON C.NUMTRANSVENDA = P.NUMTRANSVENDA
 WHERE P.DTPAG IS NULL
   AND P.NUMTRANSVENDA IN
       (11637015, 11638104, 11638648, 11639757, 11640407, 11631586);

--UPDATE OBSERVACAO TITULO
UPDATE PCPREST
   SET OBSTITULO = '04/05/2023 - FALTA DEVOLUÇÃO - FAVOR VERIFICAR' -- '01/04/2023 - FALTA DEVOLUÇÃO - FAVOR VERIFICAR'
 WHERE DTPAG IS NULL
   AND NUMTRANSVENDA IN (11637536,
11642386,
11644454,
11648120,
11649080,
11649771
);
   
--UPDATE PRESTTEF
MERGE INTO PCPREST P
USING (SELECT NUMTRANSVENDA,
              DUPLIC,
              PREST,
              PRESTTEF,
              (TO_NUMBER(PREST) - 2) PRESTTEFCALC,
              VALOR,
              CODCOB,
              VPAGO
         FROM PCPREST P
        WHERE VPAGO IS NULL
          AND PRESTTEF IS NULL
          AND P.NUMTRANSVENDA IN (11648127,
11647385,
11646792,
11647326,
11647344)
        ORDER BY DUPLIC, TO_NUMBER(PREST)) X
ON (P.NUMTRANSVENDA = X.NUMTRANSVENDA AND P.PREST = X.PREST)
WHEN MATCHED THEN
  UPDATE SET P.PRESTTEF = X.PRESTTEFCALC;

--DUPLICATA A ESTORNAR EM LOTE
SELECT P.ROWID, P.NUMCHEQUE, P.*
  FROM PCPREST P
 WHERE P.NUMTRANS IS NULL
   --AND P.CODCLI = 25047
   AND DTPAG IS NULL 
   AND P.NUMTRANSVENDA IN (11482310)
;

--UPDATE DUPLICATA A ESTORNAR EM LOTE
UPDATE PCPREST
   SET NUMCHEQUE = 3
 WHERE NUMTRANS IS NOT NULL
   AND NUMTRANSVENDA IN (11652129,
11516353,
11517452,
11517797,
11518954,
11519286,
11520018,
11520031,
11520060,
11520760,
11520827,
11521655,
11522490,
11522545,
11522548,
11522648,
11524326,
11525227,
11525872,
11526756,
11526981,
11528051,
11529022,
11533415,
11533717);

SELECT P.ROWID, P.NUMCHEQUE, P.* FROM PCPREST P WHERE P.NUMCHEQUE = 3;

--UPDATE LIMPAR NUMCHEQUE
UPDATE PCPREST SET NUMCHEQUE = NULL WHERE NUMCHEQUE = 3;
