--DUPLICATAS ANALÍTICO
SELECT P.ROWID,
       NUMCHEQUE,
       C.CLIENTE,
       P.VALORESTORNO,
       P.PRESTTEF,
       P.NUMTRANSVENDA,
       P.NUMTRANS,
       P.OBSTITULO,
       P.DTPAG,
       P.NSUHOST,
       P.NSUTEF,
       P.DTTRANSACAOCC,
       P.NUMRESUMO,
       P.PDV,
       P.CODBAIXACARTAOREDE,
       P.DTFECHA,
       P.*
  FROM PCPREST P
  LEFT JOIN PCCLIENT C ON P.CODCLI = C.CODCLI --18/01/2023 - FALTA DEVOLUÇÃO - FAVOR VERIFICAR / 16/01/2023 - DEVOLUCAO PELA MANDAE - PRAZO 27/01/2023
 WHERE P.NUMTRANSVENDA IN (11622709)
--DUPLIC (76742 ) / NSU ( 628601153 )
--P.CODCLI = 25053 --AND 
--DTEMISSAO >= TRUNC(SYSDATE) - 2 AND P.CODFILIAL = '2' AND P.CODCOB LIKE 'B2%'
--(P.NSUTEF IN (383270289) OR P.NSUHOST IN (383270289))
--P.VALOR = 92.97 AND DTEMISSAO >= TRUNC(SYSDATE) - 4 AND P.CODFILIAL = '1'
 ORDER BY DUPLIC, TO_NUMBER(PREST);

--CREDITOS_ABERTOS
WITH TRANSACAO_VENDA_DEVOLVIDA AS
 (SELECT NUMTRANSENT, MAX(M.NUMTRANSDEV) AS NUMTRANSVENDA
    FROM PCMOV M
   WHERE NVL(NUMTRANSDEV, 0) <> 0
     AND NVL(NUMTRANSDEV, 0) <> 0
   GROUP BY NUMTRANSENT)
SELECT (C.CODCLI || '-' || T.CLIENTE) CLIENTE,
       C.VALOR AS VALOR_CREDITO,
       C.DTLANC DTLANC_CRED,
       D.NUMTRANSVENDA
  FROM PCCRECLI C
  JOIN PCCLIENT T ON C.CODCLI = T.CODCLI
  JOIN TRANSACAO_VENDA_DEVOLVIDA D ON C.NUMTRANSENTDEVCLI = D.NUMTRANSENT
 WHERE --C.DTDESCONTO IS NULL AND 
--AND T.CODCLIPRINC = 459050
 T.CODCLI = 355192;

--CORREÇÃO CLIENTES
SELECT C.ROWID, C.* FROM PCCLIENT C WHERE C.CLIENTE LIKE 'PAYMEE%';

--UPDATE OBSERVACAO TITULO
UPDATE PCPREST
   SET OBSTITULO = '08/02/2023 - FALTA DEVOLUÇÃO - FAVOR VERIFICAR' --
 WHERE DTPAG IS NULL
      --AND CODCLI = 25053 --AND codfilial = '9'
   AND NUMTRANSVENDA IN (11516249,
11583630,
11583630,
11602197,
11605135
);

--UPDATE PRESTTEF
MERGE INTO PCPREST P
USING (SELECT NUMTRANSVENDA,
              DUPLIC,
              PREST,
              PRESTTEF,
              (TO_NUMBER(PREST) - 2) PRESTTEFCALC,
              VALOR,
              CODCOB,
              VPAGO
         FROM PCPREST P
        WHERE VPAGO IS NULL
          AND PRESTTEF IS NULL
          AND P.NUMTRANSVENDA IN (11607272)
        ORDER BY DUPLIC, TO_NUMBER(PREST)) X
ON (P.NUMTRANSVENDA = X.NUMTRANSVENDA AND P.PREST = X.PREST)
WHEN MATCHED THEN
  UPDATE SET P.PRESTTEF = X.PRESTTEFCALC;

--DUPLICATA A ESTORNAR EM LOTE
SELECT P.ROWID, P.NUMCHEQUE, P.*
  FROM PCPREST P
 WHERE P.NUMTRANS IS NOT NULL
       --P.NUMTRANS IS NULL
   AND P.NUMTRANSVENDA IN (11516249,
11518081
);

--UPDATE DUPLICATA A ESTORNAR EM LOTE
UPDATE PCPREST
   --SET NUMCHEQUE = 3
   SET NUMCHEQUE = NULL
 WHERE NUMTRANS IS NOT NULL
   AND NUMTRANSVENDA IN (11516249,
11518081
);
